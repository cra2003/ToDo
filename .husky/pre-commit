#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running Prettier (auto-format)..."
npx prettier --write . --log-level log
PRETTIER_RESULT=$?

if [ $PRETTIER_RESULT -ne 0 ]; then
  echo "âŒ Prettier failed. Fix formatting issues before committing."
  exit 1
fi

echo "âœ… Prettier formatting complete"

echo "ğŸ” Running ESLint..."

npm run lint

RESULT=$?

if [ $RESULT -ne 0 ]; then
  echo "âŒ ESLint errors detected. Commit blocked."
  exit 1
fi

echo "âœ… ESLint passed."

echo "ğŸ§ª Running tests with coverage (90% threshold required)..."
npm run test:coverage:check
TEST_RESULT=$?

if [ $TEST_RESULT -ne 0 ]; then
  echo "âŒ Tests failed or coverage below 90% threshold. Fix issues before committing."
  echo "   Required: 90% lines, 90% functions, 90% branches, 90% statements"
  exit 1
fi

echo "âœ… All tests passed and coverage thresholds met (â‰¥90%)."

echo "ğŸ” Running Knip (dependency checking - non-blocking)..."
npx knip --strict || true
KNIP_RESULT=$?

if [ $KNIP_RESULT -ne 0 ]; then
  echo "âš ï¸  Knip found some unused dependencies/exports (non-blocking)."
  echo "   Review and clean up when convenient."
else
  echo "âœ… Knip passed - no unused dependencies found."
fi

echo "âœ… Pre-commit checks complete. Proceeding with commit."
